# ─────────────────────────────────────────────────────────────────────
#  LogSentinel AI — Fluent Bit Log Collector
# ─────────────────────────────────────────────────────────────────────
#
#  Inputs:
#    1. Syslog over UDP  (default port 5140)  — RFC 3164
#    2. Syslog over TCP  (default port 5140)  — RFC 3164
#    3. Syslog over TCP  (default port 5141)  — RFC 5424 (modern)
#    4. OpenTelemetry OTLP — gRPC + HTTP on a single port (default 4318)
#    5. Docker container logs — tail /var/lib/docker/containers/*/*.log
#
#  Output:
#    HTTP POST to LogSentinel AI ingest API
#
#  Syslog format notes:
#    RFC 3164 (BSD/legacy) — used by most network devices, routers,
#      switches, firewalls, rsyslog, syslog-ng. This is the default.
#    RFC 5424 (modern) — used by some newer systems that explicitly
#      enable it. Listens on a separate TCP port (5141).
#
#  All ports and the backend URL are configurable via environment
#  variables set in docker-compose.yml / .env.
# ─────────────────────────────────────────────────────────────────────

[SERVICE]
    Flush           1
    Log_Level       ${LOG_LEVEL}
    Daemon          off
    Parsers_File    /fluent-bit/etc/parsers.conf
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020

# ══════════════════════════════════════════════════════════════════════
#  INPUT: Syslog — UDP (RFC 3164 — most devices use this)
# ══════════════════════════════════════════════════════════════════════
[INPUT]
    Name              syslog
    Tag               syslog.udp
    Mode              udp
    Listen            0.0.0.0
    Port              ${SYSLOG_UDP_PORT}
    Parser            syslog-rfc3164
    Buffer_Chunk_Size 64KB
    Buffer_Max_Size   128KB
    Receive_Buffer_Size 2MB
    source_address_key source_ip

# ══════════════════════════════════════════════════════════════════════
#  INPUT: Syslog — TCP (RFC 3164 — most devices use this)
# ══════════════════════════════════════════════════════════════════════
[INPUT]
    Name              syslog
    Tag               syslog.tcp
    Mode              tcp
    Listen            0.0.0.0
    Port              ${SYSLOG_TCP_PORT}
    Parser            syslog-rfc3164
    Buffer_Chunk_Size 64KB
    Buffer_Max_Size   256KB
    source_address_key source_ip

# ══════════════════════════════════════════════════════════════════════
#  INPUT: Syslog — TCP (RFC 5424 — modern syslog, separate port)
# ══════════════════════════════════════════════════════════════════════
#  Use this port for systems that explicitly send RFC 5424 format.
#  Default port: 5141 (configurable via SYSLOG_RFC5424_PORT in .env)
[INPUT]
    Name              syslog
    Tag               syslog.tcp5424
    Mode              tcp
    Listen            0.0.0.0
    Port              ${SYSLOG_RFC5424_PORT}
    Parser            syslog-rfc5424
    Buffer_Chunk_Size 64KB
    Buffer_Max_Size   256KB
    source_address_key source_ip

# ══════════════════════════════════════════════════════════════════════
#  INPUT: OpenTelemetry (OTLP/HTTP + OTLP/gRPC on the same port)
# ══════════════════════════════════════════════════════════════════════
#
#  Accepts telemetry data from OpenTelemetry SDKs, agents, and collectors.
#
#  HTTP endpoints:
#    POST /v1/logs     — OTLP log records
#    POST /v1/metrics  — OTLP metrics
#    POST /v1/traces   — OTLP trace spans
#
#  gRPC endpoints:
#    opentelemetry.proto.collector.log.v1.LogService/Export
#    opentelemetry.proto.collector.trace.v1.TraceService/Export
#    opentelemetry.proto.collector.metric.v1.MetricService/Export
#
[INPUT]
    Name              opentelemetry
    Tag               otel.logs
    Listen            0.0.0.0
    Port              ${OTEL_PORT}

# ══════════════════════════════════════════════════════════════════════
#  INPUT: Docker Container Logs (json-file driver — tailed from disk)
# ══════════════════════════════════════════════════════════════════════
#
#  Reads Docker container log files written by the json-file log driver.
#  Each line is a JSON object: {"log":"...","stream":"stdout","time":"..."}
#
#  The multiline.parser handles both Docker and CRI formats and
#  reassembles log lines that Docker splits due to its 16 KB limit.
#
#  Requires:
#    - Docker daemon configured with json-file log driver
#    - /var/lib/docker/containers mounted read-only into the container
#    - A writable volume at /fluent-bit/tail-db for offset tracking
#
[INPUT]
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    multiline.parser  docker, cri
    DB                /fluent-bit/tail-db/docker-containers.db
    Path_Key          log_path
    Read_from_Head    false
    Refresh_Interval  10
    Rotate_Wait       30
    Skip_Long_Lines   On
    Mem_Buf_Limit     10MB

# ══════════════════════════════════════════════════════════════════════
#  FILTER: Add collector metadata
# ══════════════════════════════════════════════════════════════════════
[FILTER]
    Name   record_modifier
    Match  *
    Record collector fluent-bit
    Record collector_host ${HOSTNAME}

# ══════════════════════════════════════════════════════════════════════
#  FILTER: Map syslog field names to LogSentinel AI ingest format
# ══════════════════════════════════════════════════════════════════════
#
#  Syslog parser produces:  pri, host, ident, pid, message
#  LogSentinel AI expects:  severity, host, program, message
#
[FILTER]
    Name          modify
    Match         syslog.*
    Rename        ident    program

# ══════════════════════════════════════════════════════════════════════
#  FILTER: Map Docker container log fields to LogSentinel AI format
# ══════════════════════════════════════════════════════════════════════
#
#  Docker json-file produces:  log, stream, time
#  LogSentinel AI expects:     message, host, source_ip, program
#
#  source_ip is set to 127.0.0.1 so Docker container events route to
#  the "Docker Host" system (whose selector matches source_ip=127.0.0.1).
#
[FILTER]
    Name          modify
    Match         docker.*
    Rename        log message
    Set           source_ip 127.0.0.1
    Set           host ${HOSTNAME}

# ── Multiline: merge application-level continuation lines ─────────────
# Docker's json-file driver writes each print/line as a separate JSON
# record.  Applications that format output across multiple lines
# (e.g. arrays, stack traces) produce fragmented messages.
#
# This filter concatenates continuation lines (those NOT starting
# with a recognizable log-entry prefix) into the preceding record's
# "message" field before the Lua enrichment runs.
#
# Must be placed AFTER the modify filter (which renames "log" → "message")
# and BEFORE the Lua enrichment filter.
[FILTER]
    Name                  multiline
    Match                 docker.*
    multiline.key_content message
    multiline.parser      docker_app_multiline

# ── Lua enrichment: resolve container name, map stderr, drop self-logs ──
[FILTER]
    Name          lua
    Match         docker.*
    script        /fluent-bit/etc/docker-enrich.lua
    call          enrich_docker

# ══════════════════════════════════════════════════════════════════════
#  OUTPUT: LogSentinel AI Ingest API
# ══════════════════════════════════════════════════════════════════════
[OUTPUT]
    Name              http
    Match             *
    Host              ${INGEST_HOST}
    Port              ${INGEST_PORT}
    URI               /api/v1/ingest
    Format            json
    Json_Date_Key     timestamp
    Json_Date_Format  iso8601
    Header            X-API-Key ${INGEST_API_KEY}
    Header            Content-Type application/json
    Retry_Limit       5
    Workers           2
    tls               Off
    tls.verify        Off
