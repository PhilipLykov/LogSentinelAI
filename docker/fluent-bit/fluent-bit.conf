# ─────────────────────────────────────────────────────────────────────
#  LogSentinel AI — Fluent Bit Log Collector
# ─────────────────────────────────────────────────────────────────────
#
#  Inputs:
#    1. Syslog over UDP  (default port 5140)
#    2. Syslog over TCP  (default port 5140)
#    3. OpenTelemetry OTLP — gRPC + HTTP on a single port (default 4318)
#
#  Output:
#    HTTP POST to LogSentinel AI ingest API
#
#  All ports and the backend URL are configurable via environment
#  variables set in docker-compose.yml / .env.
# ─────────────────────────────────────────────────────────────────────

[SERVICE]
    Flush           1
    Log_Level       ${LOG_LEVEL}
    Daemon          off
    Parsers_File    /fluent-bit/etc/parsers.conf
    HTTP_Server     On
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020

# ══════════════════════════════════════════════════════════════════════
#  INPUT: Syslog — UDP
# ══════════════════════════════════════════════════════════════════════
[INPUT]
    Name              syslog
    Tag               syslog.udp
    Mode              udp
    Listen            0.0.0.0
    Port              ${SYSLOG_UDP_PORT}
    Parser            syslog-rfc5424
    Buffer_Chunk_Size 64KB
    Buffer_Max_Size   128KB
    Receive_Buffer_Size 2MB
    source_address_key source_ip

# ══════════════════════════════════════════════════════════════════════
#  INPUT: Syslog — TCP
# ══════════════════════════════════════════════════════════════════════
[INPUT]
    Name              syslog
    Tag               syslog.tcp
    Mode              tcp
    Listen            0.0.0.0
    Port              ${SYSLOG_TCP_PORT}
    Parser            syslog-rfc5424
    Buffer_Chunk_Size 64KB
    Buffer_Max_Size   256KB
    source_address_key source_ip

# ══════════════════════════════════════════════════════════════════════
#  INPUT: OpenTelemetry (OTLP/HTTP + OTLP/gRPC on the same port)
# ══════════════════════════════════════════════════════════════════════
#
#  Accepts telemetry data from OpenTelemetry SDKs, agents, and collectors.
#
#  HTTP endpoints:
#    POST /v1/logs     — OTLP log records
#    POST /v1/metrics  — OTLP metrics
#    POST /v1/traces   — OTLP trace spans
#
#  gRPC endpoints:
#    opentelemetry.proto.collector.log.v1.LogService/Export
#    opentelemetry.proto.collector.trace.v1.TraceService/Export
#    opentelemetry.proto.collector.metric.v1.MetricService/Export
#
[INPUT]
    Name              opentelemetry
    Tag               otel.logs
    Listen            0.0.0.0
    Port              ${OTEL_PORT}

# ══════════════════════════════════════════════════════════════════════
#  FILTER: Add collector metadata
# ══════════════════════════════════════════════════════════════════════
[FILTER]
    Name   record_modifier
    Match  *
    Record collector fluent-bit
    Record collector_host ${HOSTNAME}

# ══════════════════════════════════════════════════════════════════════
#  FILTER: Map syslog field names to LogSentinel AI ingest format
# ══════════════════════════════════════════════════════════════════════
#
#  Syslog parser produces:  pri, host, ident, pid, message
#  LogSentinel AI expects:  severity, host, program, message
#
[FILTER]
    Name          modify
    Match         syslog.*
    Rename        ident    program

# ══════════════════════════════════════════════════════════════════════
#  OUTPUT: LogSentinel AI Ingest API
# ══════════════════════════════════════════════════════════════════════
[OUTPUT]
    Name              http
    Match             *
    Host              ${INGEST_HOST}
    Port              ${INGEST_PORT}
    URI               /api/v1/ingest
    Format            json
    Json_Date_Key     timestamp
    Json_Date_Format  iso8601
    Header            X-API-Key ${INGEST_API_KEY}
    Header            Content-Type application/json
    Retry_Limit       5
    tls               Off
    tls.verify        Off
